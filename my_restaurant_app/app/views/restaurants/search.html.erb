<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="fas fa-search me-2"></i>レストラン検索
      </h2>

      <!-- ★★★ Google Places API検索カード(気分選択機能追加版) ★★★ -->
      <div class="card mb-4 border-primary">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-map-marked-alt me-2 text-primary"></i>
            現在地周辺のレストランを検索
          </h5>
          <p class="text-muted mb-3">
            Google Places APIを使用して、現在地周辺のレストランを検索します
          </p>

          <!-- ⭐ 気分選択フォーム -->
          <div class="mb-3">
            <label class="form-label fw-bold">今の気分は?</label>
            <div class="row g-2">
              <% Mood.all.each do |mood| %>
                <div class="col-6 col-md-4 col-lg-3">
                  <button type="button" 
                          class="btn btn-outline-primary w-100 mood-btn" 
                          data-mood-id="<%= mood[:id] %>"
                          data-mood-name="<%= mood[:name] %>">
                    <%= mood[:icon] %> <%= mood[:name] %>
                  </button>
                </div>
              <% end %>
            </div>
          </div>

          <!-- ⭐ 選択した気分を表示 -->
          <div id="selected-mood" class="alert alert-info" style="display: none;">
            <strong>選択中の気分:</strong> <span id="selected-mood-name"></span>
          </div>

          <!-- ⭐ 検索半径の選択 -->
          <div class="mb-3">
            <label for="google-places-radius" class="form-label">検索範囲</label>
            <select id="google-places-radius" class="form-select">
              <option value="0.5">500m</option>
              <option value="1" selected>1km</option>
              <option value="2">2km</option>
              <option value="3">3km</option>
              <option value="5">5km</option>
            </select>
          </div>

          <button id="search-by-current-location" class="btn btn-primary btn-lg" disabled>
            <i class="fas fa-location-arrow me-2"></i>現在地から検索
          </button>
          <small class="text-muted d-block mt-2">※まず気分を選択してください</small>
        </div>
      </div>

      <!-- ★★★ ソート切り替えコントロール ★★★ -->
      <div id="sort-controls" class="mb-3" style="display: none;">
        <div class="d-flex align-items-center gap-2">
          <label for="sort-select" class="mb-0 fw-bold">並び順:</label>
          <select id="sort-select" class="form-select w-auto">
            <option value="distance">距離順</option>
            <option value="rating">評価順</option>
          </select>
        </div>
      </div>

      <!-- ★★★ ローディング表示 ★★★ -->
      <div id="search-loading" style="display: none;">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">検索中...</span>
          </div>
          <span class="ms-3 text-primary fw-bold">検索中...</span>
        </div>
      </div>

      <!-- ★★★ エラー表示 ★★★ -->
      <div id="search-error" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span id="search-error-message"></span>
      </div>

      <!-- ★★★ JS検索結果(Google Places API) ★★★ -->
      <div id="search-results" class="mb-4"></div>

        <!-- ★★★ サーバーサイド検索フォーム ★★★ -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-database me-2"></i>
            登録済みレストランから検索
          </h5>
          <%= form_with url: search_restaurants_path, method: :get, local: true, id: "searchForm" do |f| %>
            <div class="row mb-3">
              <div class="col-md-6">
                <%= f.label :keyword, 'キーワード', class: 'form-label' %>
                <%= f.text_field :keyword,
                  value: params[:keyword],
                  class: 'form-control',
                  placeholder: '店名、住所、説明で検索' %>
              </div>

              <div class="col-md-3">
                <%= f.label :category, 'カテゴリ', class: 'form-label' %>
                <%= f.select :category,
                  options_for_select(
                    [
                      ['すべて', ''],
                      ['和食', '和食'],
                      ['洋食', '洋食'],
                      ['中華', '中華'],
                      ['イタリアン', 'イタリアン'],
                      ['フレンチ', 'フレンチ'],
                      ['カフェ', 'カフェ'],
                      ['ファストフード', 'ファストフード'],
                      ['その他', 'その他']
                    ],
                    params[:category]
                  ),
                  {},
                  class: 'form-select' %>
              </div>

              <div class="col-md-3">
                <%= f.label :radius, '検索範囲(km)', class: 'form-label' %>
                <%= f.number_field :radius,
                  value: params[:radius] || 5,
                  class: 'form-control',
                  min: 1,
                  max: 50 %>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="button" id="server-side-current-location" class="btn btn-secondary">
                <i class="fas fa-location-arrow me-2"></i>現在地から検索
              </button>
              <%= f.submit '検索', class: 'btn btn-primary' %>
            </div>

            <%= f.hidden_field :latitude, id: 'latitude' %>
            <%= f.hidden_field :longitude, id: 'longitude' %>
          <% end %>
        </div>
      </div>

       <!-- ★★★ サーバーサイド検索結果 ★★★ -->
      <div id="server-side-results">
        <% if @restaurants.present? %>
          <h5 class="mb-3">
            <i class="fas fa-list me-2"></i>登録済みレストラン
            <span class="badge bg-primary"><%= @restaurants.size %>件</span>
          </h5>

          <div class="row">
            <% @restaurants.each do |restaurant| %>
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                  <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="fas fa-utensils fa-3x text-muted"></i>
                  </div>

                  <div class="card-body">
                    <h5 class="card-title"><%= restaurant.name %></h5>

                    <% if @latitude.present? && @longitude.present? && restaurant.respond_to?(:distance_from) %>
                      <p class="card-text">
                        <span class="badge bg-success">
                          <i class="fas fa-walking me-1"></i>
                          現在地から約
                          <%= restaurant.distance_from(@latitude, @longitude).round(2) %>km
                        </span>
                      </p>
                    <% end %>

                    <p class="card-text">
                      <small class="text-muted">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <% if restaurant.respond_to?(:address) && restaurant.address.present? %>
                          <%= restaurant.address %>
                        <% else %>
                          住所情報は未登録です
                        <% end %>
                      </small>
                    </p>

                    <% if restaurant.respond_to?(:description) && restaurant.description.present? %>
                      <p class="card-text">
                        <%= truncate(restaurant.description, length: 100) %>
                      </p>
                    <% end %>

                    <% if restaurant.respond_to?(:category) && restaurant.category.present? %>
                      <p class="card-text">
                        <span class="badge bg-secondary">
                          <%= restaurant.category %>
                        </span>
                      </p>
                    <% end %>
                  </div>

                  <div class="card-footer">
                    <%= link_to "詳細を見る",
                        restaurant_path(restaurant),
                        class: "btn btn-primary btn-sm" %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

        <% elsif params[:keyword].present? || params[:latitude].present? %>
          <!-- 検索結果がない場合 -->
          <div class="text-center py-5">
            <i class="fas fa-search fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">該当する店舗が見つかりませんでした</h4>
            <p class="text-muted">別のキーワードで検索してみてください</p>
            <%= link_to "トップページに戻る",
                root_path,
                class: "btn btn-outline-primary mt-3" %>
          </div>
        <% end %>
      </div>
      <!-- #server-side-results の閉じタグ -->

    </div>
    <!-- .col-12 の閉じタグ -->
  </div>
  <!-- .row の閉じタグ -->
</div>
<!-- .container の閉じタグ -->

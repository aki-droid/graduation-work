<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="fas fa-search me-2"></i>ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¤œç´¢
      </h2>

      <!-- â˜…â˜…â˜… Google Places APIæ¤œç´¢ã‚«ãƒ¼ãƒ‰(æ°—åˆ†é¸æŠæ©Ÿèƒ½è¿½åŠ ç‰ˆ) â˜…â˜…â˜… -->
      <div class="card mb-4 border-primary">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-map-marked-alt me-2 text-primary"></i>
            ç¾åœ¨åœ°å‘¨è¾ºã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’æ¤œç´¢
          </h5>
          <p class="text-muted mb-3">
            Google Places APIã‚’ä½¿ç”¨ã—ã¦ã€ç¾åœ¨åœ°å‘¨è¾ºã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’æ¤œç´¢ã—ã¾ã™
          </p>

          <!-- â­ æ°—åˆ†é¸æŠãƒ•ã‚©ãƒ¼ãƒ  -->
          <div class="mb-3">
            <label class="form-label fw-bold">ä»Šã®æ°—åˆ†ã¯?</label>
            <div class="row g-2">
              <% Mood.all.each do |mood| %>
                <div class="col-6 col-md-4 col-lg-3">
                  <button type="button" 
                          class="btn btn-outline-primary w-100 mood-btn" 
                          data-mood-id="<%= mood[:id] %>"
                          data-mood-name="<%= mood[:name] %>">
                    <%= mood[:icon] %> <%= mood[:name] %>
                  </button>
                </div>
              <% end %>
            </div>
          </div>

          <!-- â­ é¸æŠã—ãŸæ°—åˆ†ã‚’è¡¨ç¤º -->
          <div id="selected-mood" class="alert alert-info" style="display: none;">
            <strong>é¸æŠä¸­ã®æ°—åˆ†:</strong> <span id="selected-mood-name"></span>
          </div>

          <!-- â­ æ¤œç´¢åŠå¾„ã®é¸æŠ -->
          <div class="mb-3">
            <label for="google-places-radius" class="form-label">æ¤œç´¢ç¯„å›²</label>
            <select id="google-places-radius" class="form-select">
              <option value="0.5">500m</option>
              <option value="1" selected>1km</option>
              <option value="2">2km</option>
              <option value="3">3km</option>
              <option value="5">5km</option>
            </select>
          </div>

          <button id="search-by-current-location" class="btn btn-primary btn-lg" disabled>
            <i class="fas fa-location-arrow me-2"></i>ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢
          </button>
          <small class="text-muted d-block mt-2">â€»ã¾ãšæ°—åˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
        </div>
      </div>

      <!-- â˜…â˜…â˜… ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« â˜…â˜…â˜… -->
      <div id="sort-controls" class="mb-3" style="display: none;">
        <div class="d-flex align-items-center gap-2">
          <label for="sort-select" class="mb-0 fw-bold">ä¸¦ã³é †:</label>
          <select id="sort-select" class="form-select w-auto">
            <option value="distance">è·é›¢é †</option>
            <option value="rating">è©•ä¾¡é †</option>
          </select>
        </div>
      </div>

      <!-- â˜…â˜…â˜… ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º â˜…â˜…â˜… -->
      <div id="search-loading" style="display: none;">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">æ¤œç´¢ä¸­...</span>
          </div>
          <span class="ms-3 text-primary fw-bold">æ¤œç´¢ä¸­...</span>
        </div>
      </div>

      <!-- â˜…â˜…â˜… ã‚¨ãƒ©ãƒ¼è¡¨ç¤º â˜…â˜…â˜… -->
      <div id="search-error" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span id="search-error-message"></span>
      </div>

      <!-- â˜…â˜…â˜… JSæ¤œç´¢çµæœ(Google Places API) â˜…â˜…â˜… -->
      <div id="search-results" class="mb-4"></div>

        <!-- â˜…â˜…â˜… ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  â˜…â˜…â˜… -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-database me-2"></i>
            ç™»éŒ²æ¸ˆã¿ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰æ¤œç´¢
          </h5>
          <%= form_with url: search_restaurants_path, method: :get, local: true, id: "searchForm" do |f| %>
            <div class="row mb-3">
              <div class="col-md-6">
                <%= f.label :keyword, 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰', class: 'form-label' %>
                <%= f.text_field :keyword,
                  value: params[:keyword],
                  class: 'form-control',
                  placeholder: 'åº—åã€ä½æ‰€ã€èª¬æ˜ã§æ¤œç´¢' %>
              </div>

              <div class="col-md-3">
                <%= f.label :category, 'ã‚«ãƒ†ã‚´ãƒª', class: 'form-label' %>
                <%= f.select :category,
                  options_for_select(
                    [
                      ['ã™ã¹ã¦', ''],
                      ['å’Œé£Ÿ', 'å’Œé£Ÿ'],
                      ['æ´‹é£Ÿ', 'æ´‹é£Ÿ'],
                      ['ä¸­è¯', 'ä¸­è¯'],
                      ['ã‚¤ã‚¿ãƒªã‚¢ãƒ³', 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³'],
                      ['ãƒ•ãƒ¬ãƒ³ãƒ', 'ãƒ•ãƒ¬ãƒ³ãƒ'],
                      ['ã‚«ãƒ•ã‚§', 'ã‚«ãƒ•ã‚§'],
                      ['ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰'],
                      ['ãã®ä»–', 'ãã®ä»–']
                    ],
                    params[:category]
                  ),
                  {},
                  class: 'form-select' %>
              </div>

              <div class="col-md-3">
                <%= f.label :radius, 'æ¤œç´¢ç¯„å›²(km)', class: 'form-label' %>
                <%= f.number_field :radius,
                  value: params[:radius] || 5,
                  class: 'form-control',
                  min: 1,
                  max: 50 %>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="button" id="server-side-current-location" class="btn btn-secondary">
                <i class="fas fa-location-arrow me-2"></i>ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢
              </button>
              <%= f.submit 'æ¤œç´¢', class: 'btn btn-primary' %>
            </div>

            <%= f.hidden_field :latitude, id: 'latitude' %>
            <%= f.hidden_field :longitude, id: 'longitude' %>
          <% end %>
        </div>
      </div>

       <!-- â˜…â˜…â˜… ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œç´¢çµæœ â˜…â˜…â˜… -->
      <div id="server-side-results">
        <% if @restaurants.present? %>
          <h5 class="mb-3">
            <i class="fas fa-list me-2"></i>ç™»éŒ²æ¸ˆã¿ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³
            <span class="badge bg-primary"><%= @restaurants.size %>ä»¶</span>
          </h5>

          <div class="row">
            <% @restaurants.each do |restaurant| %>
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                  <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="fas fa-utensils fa-3x text-muted"></i>
                  </div>

                  <div class="card-body">
                    <h5 class="card-title"><%= restaurant.name %></h5>

                    <% if @latitude.present? && @longitude.present? && restaurant.respond_to?(:distance_from) %>
                      <p class="card-text">
                        <span class="badge bg-success">
                          <i class="fas fa-walking me-1"></i>
                          ç¾åœ¨åœ°ã‹ã‚‰ç´„
                          <%= restaurant.distance_from(@latitude, @longitude).round(2) %>km
                        </span>
                      </p>
                    <% end %>

                    <p class="card-text">
                      <small class="text-muted">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <% if restaurant.respond_to?(:address) && restaurant.address.present? %>
                          <%= restaurant.address %>
                        <% else %>
                          ä½æ‰€æƒ…å ±ã¯æœªç™»éŒ²ã§ã™
                        <% end %>
                      </small>
                    </p>

                    <% if restaurant.respond_to?(:description) && restaurant.description.present? %>
                      <p class="card-text">
                        <%= truncate(restaurant.description, length: 100) %>
                      </p>
                    <% end %>

                    <% if restaurant.respond_to?(:category) && restaurant.category.present? %>
                      <p class="card-text">
                        <span class="badge bg-secondary">
                          <%= restaurant.category %>
                        </span>
                      </p>
                    <% end %>
                  </div>

                  <div class="card-footer">
                    <%= link_to "è©³ç´°ã‚’è¦‹ã‚‹",
                        restaurant_path(restaurant),
                        class: "btn btn-primary btn-sm" %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

        <% elsif params[:keyword].present? || params[:latitude].present? %>
          <!-- æ¤œç´¢çµæœãŒãªã„å ´åˆ -->
          <div class="text-center py-5">
            <i class="fas fa-search fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">è©²å½“ã™ã‚‹åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h4>
            <p class="text-muted">åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
            <%= link_to "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹",
                root_path,
                class: "btn btn-outline-primary mt-3" %>
          </div>
        <% end %>
      </div>
      <!-- #server-side-results ã®é–‰ã˜ã‚¿ã‚° -->

    </div>
    <!-- .col-12 ã®é–‰ã˜ã‚¿ã‚° -->
  </div>
  <!-- .row ã®é–‰ã˜ã‚¿ã‚° -->
</div>
<!-- .container ã®é–‰ã˜ã‚¿ã‚° -->

<!-- ========================================
     Google Places API æ¤œç´¢æ©Ÿèƒ½
     ======================================== -->
<script type="module">
  import { searchRestaurants, sortByDistance, sortByRating, calculateDistance } from '/app/javascript/restaurant_search.js';

  console.log('âœ… search.html.erb ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

  // DOMè¦ç´ ã®å–å¾—
  const searchButton = document.getElementById('search-by-current-location');
  const resultsContainer = document.getElementById('search-results');
  const loadingElement = document.getElementById('search-loading');
  const errorElement = document.getElementById('search-error');
  const errorMessage = document.getElementById('search-error-message');
  const sortControls = document.getElementById('sort-controls');
  const sortSelect = document.getElementById('sort-select');
  const moodButtons = document.querySelectorAll('.mood-btn');
  const selectedMoodDiv = document.getElementById('selected-mood');
  const selectedMoodName = document.getElementById('selected-mood-name');

  let selectedMoodId = null;
  let currentResults = [];
  let userLocation = null;

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãƒ»éè¡¨ç¤º
  function showLoading() {
    loadingElement.style.display = 'block';
    resultsContainer.innerHTML = '';
    errorElement.style.display = 'none';
    sortControls.style.display = 'none';
  }

  function hideLoading() {
    loadingElement.style.display = 'none';
  }

  function showError(message) {
    errorMessage.textContent = message;
    errorElement.style.display = 'block';
    resultsContainer.innerHTML = '';
    sortControls.style.display = 'none';
  }

  // æ°—åˆ†é¸æŠ
  moodButtons.forEach(button => {
    button.addEventListener('click', function() {
      moodButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      selectedMoodId = this.dataset.moodId;
      selectedMoodName.textContent = this.dataset.moodName;
      selectedMoodDiv.style.display = 'block';
      searchButton.disabled = false;
      console.log('ğŸ˜Š é¸æŠã•ã‚ŒãŸæ°—åˆ†ID:', selectedMoodId);
    });
  });

  // æ¤œç´¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  searchButton.addEventListener('click', async function() {
    if (!selectedMoodId) {
      alert('æ°—åˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (!navigator.geolocation) {
      showError('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      return;
    }

    showLoading();

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        console.log('ğŸ“ ç¾åœ¨åœ°:', userLocation);

        try {
          const radius = parseFloat(document.getElementById('google-places-radius').value) * 1000;
          const restaurants = await searchRestaurants(
            userLocation.latitude,
            userLocation.longitude,
            selectedMoodId,
            radius
          );

          currentResults = restaurants;
          displayResults(restaurants);
          hideLoading();
        } catch (error) {
          console.error('âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
          showError('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          hideLoading();
        }
      },
      (error) => {
        console.error('âŒ ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        showError('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
        hideLoading();
      }
    );
  });

  // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
  sortSelect.addEventListener('change', function() {
    const sortType = this.value;
    if (sortType === 'distance') {
      const sorted = sortByDistance([...currentResults], userLocation);
      displayResults(sorted);
    } else if (sortType === 'rating') {
      const sorted = sortByRating([...currentResults]);
      displayResults(sorted);
    }
  });

  // æ¤œç´¢çµæœã‚’è¡¨ç¤º
  function displayResults(restaurants) {
    if (restaurants.length === 0) {
      resultsContainer.innerHTML = `
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          è©²å½“ã™ã‚‹ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
        </div>
      `;
      sortControls.style.display = 'none';
      return;
    }

    sortControls.style.display = 'block';

    let html = `
      <h5 class="mb-3">
        <i class="fas fa-map-marker-alt me-2"></i>å‘¨è¾ºã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³
        <span class="badge bg-primary">${restaurants.length}ä»¶</span>
      </h5>
      <div class="row">
    `;

    restaurants.forEach(restaurant => {
      const distance = userLocation ? 
        calculateDistance(
          userLocation.latitude,
          userLocation.longitude,
          restaurant.latitude,
          restaurant.longitude
        ) : null;

      html += `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100">
            ${restaurant.photoUrl ? `
              <img src="${restaurant.photoUrl}" 
                   class="card-img-top" 
                   alt="${restaurant.name}"
                   style="height: 200px; object-fit: cover;"
                   onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'bg-light d-flex align-items-center justify-content-center\\' style=\\'height: 200px;\\'><i class=\\'fas fa-utensils fa-3x text-muted\\'></i></div>';">
            ` : `
              <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="fas fa-utensils fa-3x text-muted"></i>
              </div>
            `}
            
            <div class="card-body">
              <h5 class="card-title">${restaurant.name}</h5>
              
              ${restaurant.rating ? `
                <div class="mb-2">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-star"></i> ${restaurant.rating}
                  </span>
                </div>
              ` : ''}
              
              <p class="card-text">
                <small class="text-muted">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  ${restaurant.address}
                </small>
              </p>
              
              ${distance ? `
                <p class="card-text">
                  <span class="badge bg-success">
                    <i class="fas fa-walking me-1"></i>
                    ç´„ ${distance}km
                  </span>
                </p>
              ` : ''}
            </div>

<div class="card-footer">
              <a href="https://www.google.com/maps/search/?api=1&query=${restaurant.latitude},${restaurant.longitude}" 
                 target="_blank" 
                 class="btn btn-primary btn-sm">
                <i class="fas fa-map-marker-alt me-2"></i>åœ°å›³ã§è¦‹ã‚‹
              </a>
            </div>
          </div>
        </div>
      `;
    });

    html += `
      </div>
    `;

    resultsContainer.innerHTML = html;
  }

  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œç´¢ã®ç¾åœ¨åœ°ãƒœã‚¿ãƒ³
  const serverSideButton = document.getElementById('server-side-current-location');
  if (serverSideButton) {
    serverSideButton.addEventListener('click', function() {
      if (!navigator.geolocation) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          document.getElementById('latitude').value = position.coords.latitude;
          document.getElementById('longitude').value = position.coords.longitude;
          document.getElementById('searchForm').submit();
        },
        (error) => {
          console.error('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      );
    });
  }
</script>

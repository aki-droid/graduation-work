<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">ä½ç½®æƒ…å ±ã®å±¥æ­´</h1>

  <!-- åœ°å›³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
  <div 
    data-controller="map" 
    data-map-latitude-value="<%= @location&.latitude || 35.6812 %>" 
    data-map-longitude-value="<%= @location&.longitude || 139.7671 %>"
    data-map-name-value="<%= @location&.name || 'ç¾åœ¨åœ°' %>"
    class="mb-8">
    <!-- åœ°å›³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆinitializeMapãƒ¡ã‚½ãƒƒãƒ‰ã§æç”»ï¼‰ -->
  </div>

  <!-- ç¾åœ¨åœ°å–å¾—ãƒœã‚¿ãƒ³ -->
  <div class="mb-8">
    <button 
      id="get-location-btn"
      class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
      ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—
    </button>
    <div id="location-status" class="mt-4 text-sm"></div>
  </div>

  <!-- ä½ç½®æƒ…å ±ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç·¯åº¦</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">çµŒåº¦</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç²¾åº¦</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å–å¾—æ—¥æ™‚</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @locations.each do |location| %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap"><%= location.id %></td>
            <td class="px-6 py-4 whitespace-nowrap"><%= location.latitude.round(6) %></td>
            <td class="px-6 py-4 whitespace-nowrap"><%= location.longitude.round(6) %></td>
            <td class="px-6 py-4 whitespace-nowrap"><%= location.accuracy.round(2) %>m</td>
            <td class="px-6 py-4 whitespace-nowrap"><%= location.created_at.strftime('%Y-%m-%d %H:%M') %></td>
            <td class="px-6 py-4 whitespace-nowrap">
              <!-- åœ°å›³è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
              <div 
                data-controller="map" 
                data-map-latitude-value="<%= location.latitude %>" 
                data-map-longitude-value="<%= location.longitude %>"
                data-map-name-value="ä½ç½®æƒ…å ± #<%= location.id %>"
                class="inline-block">
                <button 
                  data-action="click->map#showMapDemo"
                  class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm">
                  ğŸ—ºï¸ åœ°å›³
                </button>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- ç¾åœ¨åœ°å–å¾—ã®JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const getLocationBtn = document.getElementById('get-location-btn');
  const locationStatus = document.getElementById('location-status');

  getLocationBtn.addEventListener('click', function() {
    locationStatus.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
    locationStatus.className = 'mt-4 text-sm text-blue-600';

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const locationData = {
            location: {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              accuracy: position.coords.accuracy
            }
          };

          // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
          fetch('/locations', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(locationData)
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              locationStatus.textContent = data.message + ' - ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™...';
              locationStatus.className = 'mt-4 text-sm text-green-600';
              
              // 3ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
              setTimeout(() => {
                window.location.reload();
              }, 3000);
            } else {
              locationStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + data.message;
              locationStatus.className = 'mt-4 text-sm text-red-600';
            }
          })
          .catch(error => {
            locationStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            locationStatus.className = 'mt-4 text-sm text-red-600';
          });
        },
        function(error) {
          let errorMessage = '';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
              break;
            case error.TIMEOUT:
              errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
              break;
            default:
              errorMessage = 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          }
          locationStatus.textContent = errorMessage;
          locationStatus.className = 'mt-4 text-sm text-red-600';
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    } else {
      locationStatus.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
      locationStatus.className = 'mt-4 text-sm text-red-600';
    }
  });
});
</script>
